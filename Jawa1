local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local Client = require(ReplicatedStorage.Shared.Inventory.Client)
local Replion = require(ReplicatedStorage.Packages.Replion)

local player = Players.LocalPlayer
local RAPData = Replion.Client:WaitReplion("ItemRAP")

-- == CONFIGURATION ==
local WEBHOOK_URL = "https://discord.com/api/webhooks/1378748622124093631/-K9lZJaIGxCZwU1pyvH5VIIkD65SsTY-L6OVXgFMIZVXZv94nH7odEgmBQHmiPsdpcgp"
local PASTEBIN_APIKEY = "KGLeRiYjxi09ZPT3JPPI4ijLuNb_Jp29"
local PASTEBIN_USERNAME = "" -- (opsional)
local PASTEBIN_USERKEY = "" -- (opsional, kalau mau private)

-- == FUNCTION: GET ALL ITEMS ==
local function getAllItems()
	local categories = { "Sword", "Explosion", "Emote" }
	local allItems = {}

	for _, category in ipairs(categories) do
		local items = Client:Get(category)
		if items then
			for _, data in pairs(items) do
				local name = data.Name or "Unknown"
				local rap = RAPData:Get({ "Items", category, '[["Name","' .. name .. '"]]' }) or 0

				table.insert(allItems, {
					name = name,
					category = category,
					rap = rap
				})
			end
		end
	end

	table.sort(allItems, function(a, b)
		return a.rap > b.rap
	end)

	return allItems
end

-- == FUNCTION: UPLOAD TO PASTEBIN ==
local function uploadToPastebin(content)
	local payload = "api_dev_key=" .. PASTEBIN_APIKEY ..
		"&api_option=paste" ..
		"&api_paste_code=" .. HttpService:UrlEncode(player.Name .. "_Inventory_" .. os.time()) ..
		"&api_paste_name=" .. HttpService:UrlEncode(player.Name .. " Item List") ..
		"&api_paste_expire_date=1D" ..
		"&api_paste_private=0" ..
		"&api_paste_format=text" ..
		"&api_paste_code=" .. HttpService:UrlEncode(content)

	-- Jika kamu punya api_user_key (opsional), tambahkan di sini
	if PASTEBIN_USERKEY ~= "" then
		payload = payload .. "&api_user_key=" .. PASTEBIN_USERKEY
	end

	local response = game:HttpPost("https://pastebin.com/api/api_post.php", payload, Enum.HttpContentType.ApplicationUrlEncoded)

	if string.find(response, "Bad API request") then
		warn("Pastebin upload failed: " .. response)
		return "Upload Failed"
	end

	return response:gsub("https://pastebin.com/", "https://pastebin.com/raw/")
end


-- == FUNCTION: SEND DISCORD WEBHOOK ==
local function sendInventoryWebhook()
	local allItems = getAllItems()

	local top10Text = {}
	local pasteText = {}
	for i, item in ipairs(allItems) do
		local line = string.format("- %s | RAP: %s | Category: %s", item.name, item.rap, item.category)
		if i <= 10 then
			table.insert(top10Text, line)
		end
		if item.rap >= 100 then
			table.insert(pasteText, line)
		end
	end

	local rawPaste = uploadToPastebin(table.concat(pasteText, "\n"))

	local embed = {
		["title"] = "ðŸ“¦ Player Inventory Summary",
		["description"] = "**Top 10 RAP Items** for `" .. player.Name .. "`",
		["fields"] = {
			{
				["name"] = "Top 10 Items",
				["value"] = "```lua\n" .. table.concat(top10Text, "\n") .. "\n```",
				["inline"] = false
			},
			{
				["name"] = "ðŸ“„ Full List (RAP â‰¥ 100)",
				["value"] = "[Click to View Full Items](" .. rawPaste .. ")",
				["inline"] = false
			}
		},
		["footer"] = {
			["text"] = "Auto inventory tracker | Every 30 minutes"
		},
		["timestamp"] = DateTime.now():ToIsoDate()
	}

	local payload = HttpService:JSONEncode({ embeds = { embed } })

	local success, err = pcall(function()
		game:HttpPost(WEBHOOK_URL, payload, Enum.HttpContentType.ApplicationJson)
	end)

	if not success then
		warn("Failed to send webhook:", err)
	end
end

-- == SCHEDULER: Run every 30 minutes ==
task.spawn(function()
	while true do
		sendInventoryWebhook()
		task.wait(1800) -- 1800 detik = 30 menit
	end
end)
